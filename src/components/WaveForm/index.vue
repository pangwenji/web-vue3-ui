<template>
  <div class="envelope-wave-box">
    <div class="envelope-wave" ref="contentRef"
        @mouseleave="handleMouseleave" :style="{height: canvasHeight + 'px', 'background-color': waveBgColor}">
      <canvas
        ref="canvasRef"
        style="z-index: 1;"
        @mousemove.self="handleMouseMove"
      ></canvas>
      <div
        v-show="pointerShow"
        class="pointer"
        :style="{height: canvasHeight + 'px','margin-left': lineLeft+'px','background-color': pointerColor}"
        @click.stop="canvasClick"
      >
        <span class="time" :style="{top: pointerTop+ 'px'}">{{secondToDate(pointerTime)}}</span>
      </div>
    </div>
    <div v-if="showDbLine" class="dbbox">
      <div v-for="item in dbArr" :key="item" class="line-box">
        <div class="line-num">{{item}}</div>
        <div class="line"></div>
      </div>
    </div>
  </div>
</template>
<script setup>
import { onMounted, watch } from "vue-demi"
import { secondToDate } from "@/utils/tool";

const props = defineProps({
  audioWave: {
    type: Array,
    default: [0.043134023,0.12713072,0.14700317,0.13732561,0.17184265,0.120048985,0.14547215,0.12599973,0.097992495,0.13722818,0.109249435,0.17078206,0.17160916,0.16525397,0.12953186,0.14737545,0.1154445,0.08847745,0.12546934,0.101462856,0.15206799,0.17500305,0.13154419,0.15210935,0.123830035,0.14312193,0.11885438,0.08127695,0.14155193,0.10272253,0.109994724,0.1852553,0.13620877,0.1323051,0.11864444,0.09791308,0.17414378,0.14415602,0.14401814,0.15967238,0.25847507,0.18692476,0.18889682,0.24508134,0.22942619,0.19923383,0.16826823,0.16233091,0.13821925,0.18979874,0.23991339,0.19832344,0.19357648,0.25679955,0.26182464,0.19803923,0.15829541,0.21398467,0.1336681,0.16020882,0.19268541,0.18682162,0.17695856,0.22907671,0.20192231,0.18846755,0.19296172,0.18206254,0.20361476,0.26107696,0.22055072,0.14142618,0.15381503,0.15628916,0.15018748,0.22483054,0.20645289,0.21185303,0.16987537,0.20363791,0.21165614,0.18996751,0.22622167,0.21349584,0.18400647,0.19864516,0.15377109,0.13973024,0.17684992,0.24619505,0.21415803,0.19228795,0.24379335,0.23851915,0.2048316,0.13379475,0.22075772,0.17635722,0.17075081,0.24326849,0.19060765,0.17884275,0.22204442,0.21292683,0.19570316,0.19972818,0.15571521,0.22635071,0.27593186,0.2415198,0.13970764,0.12865917,0.16467248,0.15340157,0.22619353,0.20551346,0.21565485,0.17401013,0.24888629,0.26923838,0.26484147,0.23759644,0.2518386,0.23611505,0.23756096,0.21453784,0.19944488,0.21794717,0.24599355,0.27175775,0.24817243,0.2767095,0.2995613,0.24683058,0.20947835,0.2640061,0.23386778,0.19794603,0.24393988,0.2228831,0.25478226,0.2623725,0.25709516,0.24230663,0.2424776,0.24701571,0.26862362,0.28268984,0.2885255,0.23416652,0.24598125,0.2560537,0.24652137,0.26756322,0.28298214,0.27785942,0.20965704,0.22891952,0.27474058,0.2637252,0.21653399,0.2723065,0.24876569,0.25344664,0.19883673,0.2041433,0.2080365,0.2537785,0.29127613,0.2508885,0.2623815,0.2912686,0.25591102,0.23289362,0.2362487,0.24628164,0.18620135,0.23609667,0.23851179,0.25489238,0.24573728,0.25259307,0.23946151,0.2519682,0.2436426,0.26764247,0.2651176,0.29694852,0.24012701,0.2432273,0.25782463,0.24335268,0.2503173,0.29160264,0.26570407,0.22507045,0.24297728,0.29396975,0.23966888,0.22813268,0.27341285,0.2734546,0.26572815,0.20347632,0.1949621,0.21749878,0.28461465,0.30011648,0.23486218,0.2618732,0.27932757,0.27000427,0.26090047,0.22946167,0.24937439,0.20060013,0.28607544,0.272608,0.2517316,0.25917917,0.26741213,0.24177276,0.24350895,0.20960006,0.2508532,0.2755638,0.31193194,0.24274473,0.17890562,0.20840509,0.21469502,0.19965667,0.21610306,0.25626805,0.25926447,0.26753584,0.30540282,0.2511604,0.206918,0.25838405,0.27552244,0.25353214,0.20765318,0.22291197,0.22500427,0.28400743,0.30117965,0.2886667,0.24518466,0.28747743,0.2811292,0.27378348,0.2394457,0.27353457,0.236382,0.28568533,0.2870101,0.25641477,0.25312474,0.273095,0.25766525,0.26303652,0.24330011,0.2829476,0.28169987,0.29319027,0.27584636,0.26796916,0.31047186,0.27073503,0.24072634,0.2774794,0.299626,0.28161418,0.27519393,0.30480736,0.30519712,0.29526785,0.2539568,0.2328517,0.23987,0.24372827,0.25060153,0.24684767,0.26516062,0.27504757,0.26205388,0.19317755,0.19762853,0.24887471,0.26754594,0.2656399,0.25590754,0.26765075,0.28223264,0.28861523,0.26406622,0.24883978,0.2277251,0.23843347,0.23726001,0.24685007,0.22824042,0.21927947,0.3169504,0.326473,0.33219284,0.32010144,0.28083968,0.28406075,0.28774768,0.28922704,0.27222747,0.23609538,0.26641074,0.23504676,0.2289517,0.24859619,0.2060898,0.21956386,0.2294874,0.21589127,0.2432148,0.23909089,0.27360848,0.25693667,0.23782146,0.20161621,0.24177662,0.24446289,0.21762784,0.23793268,0.2223963,0.24474086,0.2889998,0.2724444,0.25147238,0.22901052,0.23915283,0.21788669,0.21541329,0.2232484,0.21239388,0.28381237,0.2969,0.25770092,0.24367827,0.23198065,0.26785463,0.2982093,0.27867955,0.27754578,0.23698094,0.22327432,0.2339926,0.21652718,0.18956067,0.1689521,0.21798007,0.20507371,0.1747635,0.14490004,0.17481756,0.24360657,0.23507525,0.20159434,0.19177724,0.19477697,0.21075954,0.19379048,0.18997616,0.17531724,0.150987,0.21806133,0.19554634,0.21522595,0.18133508,0.18533178,0.1755246,0.15735838,0.19288856,0.1286281,0.21928002,0.28607875,0.23688479,0.23502065,0.28586754,0.26215518,0.24523135,0.22393982,0.22504508,0.174553,0.21881692,0.2635281,0.26729372,0.21393391,0.22068033,0.22846636,0.23146664,0.20315827,0.20380889,0.19920442,0.25591728,0.26443115,0.24423696,0.20862791,0.20661889,0.25457066,0.2332668,0.22843695,0.21030287,0.18595187,0.23575638,0.25756505,0.23192625,0.23191006,0.19924173,0.17996418,0.2013684,0.2274328,0.1919905,0.22073898,0.314568,0.28124154,0.27362135,0.2677469,0.26506686,0.26852638,0.26829013,0.24541703,0.22465754,0.21689045,0.27823243,0.27367485,0.25983107,0.25084695,0.24418713,0.2435869,0.22939695,0.24203895,0.22261065,0.27885714,0.29430968,0.2693329,0.22304066,0.24312913,0.27146268,0.2489168,0.24270262,0.22607808,0.22622368,0.2639629,0.31021982,0.2830228,0.26511428,0.21588153,0.23248714,0.24060996,0.26086298,0.22937343,0.24031729,0.3145173,0.30202088,0.3050901,0.29947358,0.28185228,0.28078434,0.28314853,0.27395427,0.27227747,0.24235865,0.27372265,0.25659767,0.299244,0.25824562,0.23664562,0.23886843,0.23421212,0.25197738,0.24125268,0.28861722,0.27319905,0.2648514,0.2394036,0.24158652,0.25908577,0.25906372,0.23300263,0.24836749,0.23731554,0.25740603,0.2932664,0.29065087,0.2596735,0.23372862,0.22935082,0.22860736,0.2587058,0.22007807,0.20937504,0.33047467,0.3226083,0.31141,0.3079959,0.3129504,0.26676813,0.29047716,0.29928276,0.26673815,0.21671157,0.23442556,0.24532402,0.19598775,0.21234462,0.19137353,0.20229809,0.21446541,0.16968398,0.18184413,0.23090114,0.2582131,0.23152143,0.21665826,0.17122567,0.2306263,0.22749366,0.19980502,0.2017337,0.17859235,0.21585065,0.24440499,0.20847477,0.20614918,0.18694738,0.20371771,0.20086174,0.17143618,0.1777875,0.15698738,0.28436923,0.30112135,0.26450062,0.2299939,0.24779133,0.25056642,0.2655305,0.23941316,0.25379962,0.21689817,0.25607115,0.25064987,0.21120885,0.21194991,0.18316743,0.21294762,0.21922064,0.17437156,0.18112017,0.21714525,0.2653485,0.24911426,0.20436335,0.18161783,0.21394937,0.21972418,0.21189862,0.1993662,0.19943771,0.206017,0.2527341,0.21194458,0.22075883,0.19642346,0.20050159,0.18787909,0.18146431,0.182146,0.17071185,0.25061053,0.26053664,0.23733999,0.2246638,0.105702415,0.14503314,0.13863401,0.1525252,0.1450927,0.14011815,0.07067117,0.027905935,0.010799729,0.0048701274,0.002202781,0.0012843121,7.020881E-4,4.4544635E-4,2.7980574E-4,1.5516166E-4,1.00377096E-4,7.6293945E-5],
  },
  duration: { // 音频时长
    type: Number,
    default: 0
  },
  canvasHeight: { //canvas高度
    type: Number,
    default: 260
  },
  shapeHeight: { //音波高度
    type: Number,
    default: 260
  },
  waveColor: { //音波颜色
    type: String,
    default: 'rgb(119,117,117,.8)'
  },
	progressColor: { //进度条颜色
    type: String,
    default: 'rgb(255,255,255,.9)'
  },
  pointerColor: { //指针颜色
    type: String,
    default: '#ffffff'
  },
  playPercent: { // 播放百分比
    type: Number,
    default: 0
  },
  waveStep: { // 波形取值间隔
    type: Number,
    default: 1
  },
  waveBgColor: { // 背景颜色
    type: String,
    default: ''
  },
  showDbLine: {
    type: Boolean,
    default: false
  },
  waveWidth: { //波形增加宽度
    type: Number,
    default: 0
  }
})

const emit = defineEmits();
const nowPlay = ref(0)
const contentRef = ref('')
const canvasRef = ref('')
const lineLeft = ref(0)
const pointerShow = ref(false) // 指针显示
const pointerTime = ref(0) // 指针时间
const dbArr = ref([-3,-6,-9,-12,-15,-12,-9,-6,-3])

onMounted(() => {
  drawWave()
})

watch(() => props.playPercent, newVal => {
  drawWave()
})

function drawWave() {
  const canvas = canvasRef.value
  const contentWidth = contentRef.value.clientWidth
  canvas.width = contentWidth
  canvas.height = props.canvasHeight
  const ctx = canvas.getContext('2d')
  let [x0, y0] = [0, props.canvasHeight/2] // x轴0处坐标,y轴0处坐标
  const waveform = props.audioWave || []
  let [width, xDis, times] = [.7, 1, waveform.length] // 设定每个柱子的宽度,设定柱子之前的间距
  xDis = (contentWidth - times)/times  + 1

  let maxWave = 0
  for(let i = 0; i < times; i += props.waveStep){
    if (waveform[i] > maxWave) {
      maxWave = waveform[i]
    }
  }
  
  //绘制柱状和在顶部显示值
  for(let i = 0; i < times; i += props.waveStep){
    ctx.beginPath()
    // const color = '#' + Math.random().toString(16).substr(2, 6).toUpperCase();//随机颜色
    // ctx.fillStyle=color;
    // ctx.fillStyle = props.waveColor

    if (i <= times * props.playPercent / 100) {
      ctx.fillStyle = props.progressColor
    } else {
      ctx.fillStyle = props.waveColor
    }

    // let height = waveform[i] * props.shapeHeight/2 //高度
    let height = props.shapeHeight/2 * (waveform[i]/maxWave) //高度

    if (height < 1) {
      height = 1
    }
    const rectX = x0+xDis*i //柱子的x位置
    ctx.fillRect(rectX,y0, width + props.waveWidth, -height) //绘制一个柱状
    ctx.fillRect(rectX, y0 + 0 + height, width + props.waveWidth, -height) //绘制一个柱状
  }
}

function canvasClick(e) {
  const contentWidth = contentRef.value.clientWidth
  const offsetX = lineLeft.value
  const percent = (offsetX/contentWidth).toFixed(3) * 100
  emit('onPlayPercent', percent)
}

const pointerTop = ref(0)
function handleMouseMove(e) {
  pointerShow.value = true
  lineLeft.value = e.offsetX
  pointerTop.value = e.offsetY + 10
  const contentWidth = contentRef.value.clientWidth
  pointerTime.value = Math.round(e.offsetX / contentWidth * props.duration)
  if (pointerTime.value < 0) {
    pointerShow.value = false
  }
}

function handleMouseleave(e) {
  pointerShow.value = false
}

defineExpose({
  drawWave
})

</script>
<style lang="scss" scoped>
  @import "./style.scss";
</style>
